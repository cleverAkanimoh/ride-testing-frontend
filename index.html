<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Request Testing Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            min-width: 140px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .response-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }

        .response-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .response-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .location-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .multi-stop-container {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .stop-location {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .stop-location input {
            flex: 1;
        }

        .remove-stop {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-accepted {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .auth-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .auth-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .ride-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .coordinate-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .location-grid {
                grid-template-columns: 1fr;
            }
            
            .coordinate-input {
                grid-template-columns: 1fr;
            }
            
            .ride-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .success {
            color: #28a745;
            font-weight: 600;
        }

        .error {
            color: #dc3545;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Ride Request Testing</h1>
            <p>Test your ride-hailing API with both User and Driver interfaces</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('user')">üë§ User Interface</div>
            <div class="tab" onclick="switchTab('driver')">üöó Driver Interface</div>
        </div>

        <!-- USER INTERFACE -->
        <div id="user-tab" class="tab-content active">
            <div class="auth-section">
                <h4>üîê Authentication</h4>
                <p><strong>JWT Token:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4NDAwOTM4NjQ4YjI4Y2JkMjY0ZjE1YSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzQ5MDI3Mjg2LCJleHAiOjYwNDgwMDAwMTc0OTAyNzMwMH0.qvPNqh6lvN-nJ22p4BIg4ePePTPmfvT6S5aGBDYRqGU</p>
            </div>

            <form id="rideRequestForm">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isMultiStop" onchange="toggleMultiStop()"> Multi-Stop Ride
                    </label>
                </div>

                <div class="location-grid">
                    <div class="form-group">
                        <label for="pickupLocation">üìç Pickup Location</label>
                        <input type="text" id="pickupLocation" placeholder="Enter pickup address or leave blank for coordinates" value="Federal University Lokoja (Permanent Site), Felele, Lokoja, Kogi" />
                        <div class="coordinate-input" style="margin-top: 10px;">
                            <input type="number" id="pickupLat" placeholder="Latitude" step="any" />
                            <input type="number" id="pickupLng" placeholder="Longitude" step="any" />
                        </div>
                    </div>

                    <div id="singleDropoff" class="form-group">
                        <label for="dropoffLocation">üéØ Dropoff Location</label>
                        <input type="text" id="dropoffLocation" placeholder="Enter dropoff address or leave blank for coordinates" value="Kogi State Polytechnic Main Campus, Osara Road, Lokoja, Kogi" />
                        <div class="coordinate-input" style="margin-top: 10px;">
                            <input type="number" id="dropoffLat" placeholder="Latitude" step="any" />
                            <input type="number" id="dropoffLng" placeholder="Longitude" step="any" />
                        </div>
                    </div>
                </div>

                <div id="multiStopContainer" class="multi-stop-container" style="display: none;">
                    <h4>üéØ Multiple Stops</h4>
                    <div id="stopLocations"></div>
                    <button type="button" class="btn btn-secondary" onclick="addStop()">+ Add Stop</button>
                </div>

                <div class="location-grid">
                    <div class="form-group">
                        <label for="paymentMethod">üí≥ Payment Method</label>
                        <select id="paymentMethod">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="momo">MoMo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="promoCode">üé´ Promo Code (Optional)</label>
                        <input type="text" id="promoCode" placeholder="Enter promo code" />
                    </div>
                </div>

                <div class="ride-actions">
                    <button type="submit" class="btn">üì± Request Ride</button>
                    <button type="button" class="btn btn-secondary" onclick="getRideHistory()">üìã Ride History</button>
                    <button type="button" class="btn btn-warning" onclick="testCoordinates()">üß™ Test with Sample Coordinates</button>
                </div>
            </form>

            <div id="userActions" style="display: none;">
                <h3>üöó Current Ride Actions</h3>
                <input type="text" id="currentRideId" placeholder="Current Ride ID" readonly style="margin-bottom: 15px;" />
                <div class="ride-actions">
                    <button class="btn btn-secondary" onclick="getRideStatus()">üìä Get Status</button>
                    <button class="btn btn-warning" onclick="trackRide()">üìç Track Ride</button>
                    <button class="btn btn-danger" onclick="cancelRide()">‚ùå Cancel Ride</button>
                    <button class="btn" onclick="sendUserMessage()">üí¨ Send Message</button>
                    <button class="btn btn-success" onclick="rateDriver()">‚≠ê Rate Driver</button>
                    <button class="btn btn-secondary" onclick="copyCurrentRideId()">üìã Copy Ride ID</button>
                    <button id="autoRefreshBtn" class="btn btn-warning" onclick="toggleAutoRefresh()">üîÑ Start Auto Refresh</button>
                    <button class="btn btn-secondary" onclick="clearResponses()">üóëÔ∏è Clear Responses</button>
                </div>
            </div>

            <div id="userResponse" class="response-section">
                <h3>üìã Response</h3>
                <div id="userResponseContent" class="response-content">Waiting for API response...</div>
            </div>
        </div>

        <!-- DRIVER INTERFACE -->
        <div id="driver-tab" class="tab-content">
            <div class="auth-section">
                <h4>üîê Authentication</h4>
                <p><strong>JWT Token:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDEyNzg1N2JjOGIwMTFmYjllNzY5NCIsImZpcnN0TmFtZSI6IkNsZXZlciIsInJvbGUiOiJkcml2ZXIiLCJpYXQiOjE3NDg2OTY1MDMsImV4cCI6NjA0ODAwMDAxNzQ4Njk2NDAwfQ.h_LaYaLYxjbEMQxmnYbOId2boCer8gAhqcxKxcGO_ko</p>
            </div>

            <div class="form-group">
                <label for="rideIdForDriver">üéØ Ride ID</label>
                <input type="text" id="rideIdForDriver" placeholder="Enter Ride ID to manage" />
            </div>

            <div class="location-grid">
                <div class="form-group">
                    <label for="driverLat">üìç Driver Latitude</label>
                    <input type="number" id="driverLat" placeholder="5.6037" step="any" value="5.6037" />
                </div>
                <div class="form-group">
                    <label for="driverLng">üìç Driver Longitude</label>
                    <input type="number" id="driverLng" placeholder="-0.1870" step="any" value="-0.1870" />
                </div>
            </div>

            <div class="ride-actions">
                <button class="btn btn-success" onclick="acceptRide()">‚úÖ Accept Ride</button>
                <button class="btn btn-danger" onclick="rejectRide()">‚ùå Reject Ride</button>
                <button class="btn" onclick="arrivedAtPickup()">üìç Arrived at Pickup</button>
                <button class="btn btn-warning" onclick="startRide()">üöÄ Start Ride</button>
                <button class="btn btn-success" onclick="completeRide()">‚úÖ Complete Ride</button>
            </div>

            <div class="ride-actions">
                <button class="btn btn-secondary" onclick="updateDriverLocation()">üìç Update Location</button>
                <button class="btn" onclick="sendDriverMessage()">üí¨ Send Message</button>
                <button class="btn btn-danger" onclick="cancelRideAsDriver()">‚ùå Cancel Ride</button>
                <button class="btn btn-success" onclick="confirmCashPayment()">üí∞ Confirm Cash Payment</button>
            </div>

            <div class="ride-actions">
                <button class="btn btn-secondary" onclick="getDriverHistory()">üìã Ride History</button>
                <button class="btn btn-warning" onclick="getEarnings()">üí∞ Earnings Report</button>
                <button class="btn" onclick="rateUser()">‚≠ê Rate User</button>
                <button class="btn btn-secondary" onclick="loadSampleRideId()">üé≤ Load Sample ID</button>
            </div>

            <div class="form-group">
                <label for="stopIndex">üõë Stop Index (for multi-stop rides)</label>
                <input type="number" id="stopIndex" placeholder="0, 1, 2..." min="0" />
                <button class="btn btn-success" onclick="completeStop()" style="margin-top: 10px;">‚úÖ Complete Stop</button>
            </div>

            <div id="driverResponse" class="response-section">
                <h3>üìã Response</h3>
                <div id="driverResponseContent" class="response-content">Waiting for API response...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const API_BASE = 'https://api-freedom.com/api/v2';
        const USER_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4NDAwOTM4NjQ4YjI4Y2JkMjY0ZjE1YSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzQ5MDI3Mjg2LCJleHAiOjYwNDgwMDAwMTc0OTAyNzMwMH0.qvPNqh6lvN-nJ22p4BIg4ePePTPmfvT6S5aGBDYRqGU';
        const DRIVER_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4NDAxMWNjYmYwZDNjNWVjZDY0MmQxZSIsImZpcnN0TmFtZSI6IkNsZXZlciIsInJvbGUiOiJkcml2ZXIiLCJpYXQiOjE3NDkyMDM2NDcsImV4cCI6NjA0ODAwMDAxNzQ5MjAzNjAwfQ.d2NkZFXs6-i-CsDkIRC1Sa8TSiguEiPGxkak5e3Myko';

        let currentRideId = null;
        let stopCount = 0;
        let userSocket = null;
        let driverSocket = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tab === 'user' ? '1' : '2'})`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            // Connect appropriate socket when switching tabs
            if (tab === 'user') {
                connectUserSocket();
            } else if (tab === 'driver') {
                // connectDriverSocket();
            }
        }

        // Socket Connection Functions
        function connectUserSocket() {
            if (userSocket && userSocket.connected) {
                displayResponse('user', '‚úÖ User already connected via WebSocket');
                return;
            }

            displayResponse('user', 'üîå Connecting user WebSocket...');
            
            userSocket = io('https://api-freedom.com', {
                auth: { token: USER_TOKEN },
                transports: ['websocket', 'polling']
            });

            userSocket.on('connect', () => {
                displayResponse('user', '‚úÖ User WebSocket connected! Socket ID: ' + userSocket.id);
            });

            userSocket.on('connect_error', (error) => {
                displayResponse('user', '‚ùå User WebSocket connection error: ' + error.message);
            });

            userSocket.on('disconnect', (reason) => {
                displayResponse('user', '‚ö†Ô∏è User WebSocket disconnected: ' + reason);
            });

            // Listen for ride status updates
            userSocket.on('ride_status_updated', (data) => {
                displayResponse('user', 'üìä Ride Status Update Received:\n' + JSON.stringify(data, null, 2));
                
                // Auto-update current ride status
                if (data.rideId === currentRideId) {
                    getRideStatus();
                }
            });

            // Listen for no drivers found
            userSocket.on('no_drivers_found', (data) => {
                displayResponse('user', '‚ö†Ô∏è No Drivers Found:\n' + JSON.stringify(data, null, 2));
            });

            // Listen for ride auto-cancellation
            userSocket.on('ride_auto_cancelled', (data) => {
                displayResponse('user', '‚ùå Ride Auto-Cancelled:\n' + JSON.stringify(data, null, 2));
            });

            // Generic notification handler
            userSocket.on('notification', (data) => {
                displayResponse('user', 'üîî Notification:\n' + JSON.stringify(data, null, 2));
            });
        }

        function connectDriverSocket() {
            if (driverSocket && driverSocket.connected) {
                displayResponse('driver', '‚úÖ Driver already connected via WebSocket');
                return;
            }

            displayResponse('driver', 'üîå Connecting driver WebSocket...');
            
            // driverSocket = io('https://api-freedom.com', {
            //     auth: { token: DRIVER_TOKEN },
            //     transports: ['websocket', 'polling']
            // });

            driverSocket.on('connect', () => {
                displayResponse('driver', '‚úÖ Driver WebSocket connected! Socket ID: ' + driverSocket.id);
            });

            driverSocket.on('connect_error', (error) => {
                displayResponse('driver', '‚ùå Driver WebSocket connection error: ' + error.message);
            });

            driverSocket.on('disconnect', (reason) => {
                displayResponse('driver', '‚ö†Ô∏è Driver WebSocket disconnected: ' + reason);
            });

            driverSocket.on('connection_confirmed', (data) => {
                displayResponse('driver', '‚úÖ Driver Connection Confirmed:\n' + JSON.stringify(data, null, 2));
            });

            // Listen for new ride requests - THIS IS THE IMPORTANT ONE!
            // driverSocket.on('new_ride_request', (data) => {
            //     displayResponse('driver', 'üöó NEW RIDE REQUEST RECEIVED!\n' + JSON.stringify(data, null, 2));
                
            //     // Auto-fill ride ID for easy testing
            //     document.getElementById('rideIdForDriver').value = data.rideId;
                
            //     // Show notification to user
            //     if (confirm('üöó New ride request received!\n\nRide ID: ' + data.rideId + '\nFare: ' + data.currency + ' ' + data.estimatedFare + '\n\nAccept this ride?')) {
            //         // Auto-accept the ride
            //         acceptRide();
            //     }
            // });

            // // Listen for new delivery requests
            // driverSocket.on('new_delivery_request', (data) => {
            //     displayResponse('driver', 'üöö NEW DELIVERY REQUEST RECEIVED!\n' + JSON.stringify(data, null, 2));
            //     document.getElementById('rideIdForDriver').value = data.deliveryId;
            // });

            // Listen for ride status updates
            driverSocket.on('ride_status_updated', (data) => {
                displayResponse('driver', 'üìä Ride Status Update:\n' + JSON.stringify(data, null, 2));
            });

            // Listen for ride acceptance responses
            driverSocket.on('ride_accepted', (data) => {
                displayResponse('driver', '‚úÖ Ride Acceptance Response:\n' + JSON.stringify(data, null, 2));
            });

            driverSocket.on('ride_rejected', (data) => {
                displayResponse('driver', '‚ùå Ride Rejection Response:\n' + JSON.stringify(data, null, 2));
            });

            // Generic notification handler
            driverSocket.on('notification', (data) => {
                displayResponse('driver', 'üîî Notification:\n' + JSON.stringify(data, null, 2));
            });

            // Listen for location update responses
            driverSocket.on('location_updated', (data) => {
                displayResponse('driver', 'üìç Location Updated:\n' + JSON.stringify(data, null, 2));
            });

            driverSocket.on('location_error', (data) => {
                displayResponse('driver', '‚ùå Location Error:\n' + JSON.stringify(data, null, 2));
            });
        }

        function toggleMultiStop() {
            const isMultiStop = document.getElementById('isMultiStop').checked;
            document.getElementById('singleDropoff').style.display = isMultiStop ? 'none' : 'block';
            document.getElementById('multiStopContainer').style.display = isMultiStop ? 'block' : 'none';
            
            if (isMultiStop && stopCount === 0) {
                addStop();
                addStop();
            }
        }

        function addStop() {
            stopCount++;
            const container = document.getElementById('stopLocations');
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop-location';
            stopDiv.innerHTML = `
                <input type="text" placeholder="Stop ${stopCount} address" class="stop-address" />
                <input type="number" placeholder="Lat" step="any" class="stop-lat" />
                <input type="number" placeholder="Lng" step="any" class="stop-lng" />
                <button type="button" class="remove-stop" onclick="removeStop(this)">Remove</button>
            `;
            container.appendChild(stopDiv);
        }

        function removeStop(button) {
            button.parentElement.remove();
        }


        async function makeRequest(endpoint, method = 'GET', data = null, isDriver = false) {
            const token = isDriver ? DRIVER_TOKEN : USER_TOKEN;
            
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();

                return {
                    status: response.status,
                    data: result
                };
            } catch (error) {
                return {
                    status: 500,
                    data: { error: error.message }
                };
            }
        }

        function displayResponse(type, response) {
            const content = document.getElementById(`${type}ResponseContent`);
            content.textContent = typeof response === 'string' ? response : JSON.stringify(response, null, 2);
        }

        // USER FUNCTIONS
        document.getElementById('rideRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const isMultiStop = document.getElementById('isMultiStop').checked;
            let requestData = {
                paymentMethod: document.getElementById('paymentMethod').value,
                promoCode: document.getElementById('promoCode').value || undefined
            };

            // Handle pickup location
            const pickupAddr = document.getElementById('pickupLocation').value;
            const pickupLat = document.getElementById('pickupLat').value;
            const pickupLng = document.getElementById('pickupLng').value;

            if (pickupAddr) {
                requestData.pickupLocation = pickupAddr;
            } else if (pickupLat && pickupLng) {
                requestData.pickupLocation = {
                    coordinates: [parseFloat(pickupLng), parseFloat(pickupLat)],
                    address: `Coordinates: ${pickupLat}, ${pickupLng}`
                };
            } else {
                alert('Please provide either pickup address or coordinates');
                return;
            }

            if (isMultiStop) {
                const stops = [];
                document.querySelectorAll('.stop-location').forEach(stop => {
                    const addr = stop.querySelector('.stop-address').value;
                    const lat = stop.querySelector('.stop-lat').value;
                    const lng = stop.querySelector('.stop-lng').value;

                    if (addr) {
                        stops.push(addr);
                    } else if (lat && lng) {
                        stops.push({
                            coordinates: [parseFloat(lng), parseFloat(lat)],
                            address: `Coordinates: ${lat}, ${lng}`
                        });
                    }
                });
                requestData.dropoffLocations = stops;
            } else {
                const dropoffAddr = document.getElementById('dropoffLocation').value;
                const dropoffLat = document.getElementById('dropoffLat').value;
                const dropoffLng = document.getElementById('dropoffLng').value;

                if (dropoffAddr) {
                    requestData.dropoffLocation = dropoffAddr;
                } else if (dropoffLat && dropoffLng) {
                    requestData.dropoffLocation = {
                        coordinates: [parseFloat(dropoffLng), parseFloat(dropoffLat)],
                        address: `Coordinates: ${dropoffLat}, ${dropoffLng}`
                    };
                } else {
                    alert('Please provide either dropoff address or coordinates');
                    return;
                }
            }

            displayResponse('user', 'Requesting ride...');
            
            const response = await makeRequest('/user/ride/request', 'POST', requestData);
            displayResponse('user', response);

            if (response.status === 201 && response.data.success) {
                currentRideId = response.data.data.rideId;
                document.getElementById('currentRideId').value = currentRideId;
                document.getElementById('userActions').style.display = 'block';
            }
        });

        async function getRideStatus() {
            if (!currentRideId) {
                alert('No current ride ID');
                return;
            }

            const response = await makeRequest(`/user/ride/${currentRideId}`);
            displayResponse('user', response);
        }

        async function getRideHistory() {
            const response = await makeRequest('/user/ride/rideHistory');
            displayResponse('user', response);
        }

        async function trackRide() {
            if (!currentRideId) {
                alert('No current ride ID');
                return;
            }

            const response = await makeRequest(`/user/ride/${currentRideId}/track`);
            displayResponse('user', response);
        }

        async function cancelRide() {
            if (!currentRideId) {
                alert('No current ride ID');
                return;
            }

            const reason = prompt('Cancellation reason:') || 'User cancelled';
            const response = await makeRequest(`/user/ride/${currentRideId}/cancel`, 'POST', { reason });
            displayResponse('user', response);
        }

        async function sendUserMessage() {
            if (!currentRideId) {
                alert('No current ride ID');
                return;
            }

            const message = prompt('Enter message:');
            if (!message) return;

            const response = await makeRequest(`/user/ride/${currentRideId}/message`, 'POST', { message });
            displayResponse('user', response);
        }

        async function rateDriver() {
            if (!currentRideId) {
                alert('No current ride ID');
                return;
            }

            const rating = prompt('Rate driver (1-5):');
            const comment = prompt('Comment (optional):');
            
            if (!rating || rating < 1 || rating > 5) {
                alert('Please provide a valid rating (1-5)');
                return;
            }

            const response = await makeRequest(`/user/ride/${currentRideId}/rate`, 'POST', { 
                rating: parseInt(rating), 
                comment 
            });
            displayResponse('user', response);
        }

        // DRIVER FUNCTIONS
        async function acceptRide() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || !lat || !lng) {
                alert('Please provide ride ID and driver coordinates');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/accept`, 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        async function rejectRide() {
            const rideId = document.getElementById('rideIdForDriver').value;
            if (!rideId) {
                alert('Please provide ride ID');
                return;
            }

            const reason = prompt('Rejection reason:') || 'Driver unavailable';
            const response = await makeRequest(`/driver/ride/${rideId}/reject`, 'POST', { reason }, true);
            displayResponse('driver', response);
        }

        async function arrivedAtPickup() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || !lat || !lng) {
                alert('Please provide ride ID and driver coordinates');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/arrived`, 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        async function startRide() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || !lat || !lng) {
                alert('Please provide ride ID and driver coordinates');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/start`, 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        async function completeRide() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || !lat || !lng) {
                alert('Please provide ride ID and driver coordinates');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/complete`, 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        async function completeStop() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const stopIndex = document.getElementById('stopIndex').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || stopIndex === '' || !lat || !lng) {
                alert('Please provide ride ID, stop index, and driver coordinates');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/stop/${stopIndex}/complete`, 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        // Enhanced driver location update with socket
        async function updateDriverLocation() {
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!lat || !lng) {
                alert('Please provide driver coordinates');
                return;
            }

            // Send via socket if connected
            if (driverSocket && driverSocket.connected) {
                displayResponse('driver', 'üìç Sending location via WebSocket...');
                driverSocket.emit('update_location', {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lng),
                    status: 'available'
                });
            }

            // Also send via HTTP API
            const response = await makeRequest('/driver/ride/location', 'POST', {
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        // Add socket connection buttons to interface
        function addSocketControls() {
            // Add user socket controls
            const userActions = document.getElementById('userActions');
            if (userActions) {
                const socketBtn = document.createElement('button');
                socketBtn.className = 'btn btn-secondary';
                socketBtn.textContent = 'üîå Connect WebSocket';
                socketBtn.onclick = connectUserSocket;
                userActions.querySelector('.ride-actions').appendChild(socketBtn);
            }

            // Add driver socket controls  
            const driverActions = document.querySelector('#driver-tab .ride-actions');
            // if (driverActions) {
            //     const socketBtn = document.createElement('button');
            //     socketBtn.className = 'btn btn-secondary';
            //     socketBtn.textContent = 'üîå Connect WebSocket';
            //     socketBtn.onclick = connectDriverSocket;
            //     driverActions.appendChild(socketBtn);
            // }
        }

        async function sendDriverMessage() {
            const rideId = document.getElementById('rideIdForDriver').value;
            if (!rideId) {
                alert('Please provide ride ID');
                return;
            }

            const message = prompt('Enter message to user:');
            if (!message) return;

            const response = await makeRequest(`/driver/ride/${rideId}/message`, 'POST', { message }, true);
            displayResponse('driver', response);
        }

        async function getDriverHistory() {
            const response = await makeRequest('/driver/ride/history', 'GET', null, true);
            displayResponse('driver', response);
        }

        async function getEarnings() {
            const period = prompt('Enter period (today, week, month, custom):') || 'week';
            let endpoint = `/driver/ride/earnings?period=${period}`;
            
            if (period === 'custom') {
                const startDate = prompt('Start date (YYYY-MM-DD):');
                const endDate = prompt('End date (YYYY-MM-DD):');
                if (startDate && endDate) {
                    endpoint = `/driver/ride/earnings?period=custom&startDate=${startDate}&endDate=${endDate}`;
                }
            }

            const response = await makeRequest(endpoint, 'GET', null, true);
            displayResponse('driver', response);
        }

        async function cancelRideAsDriver() {
            const rideId = document.getElementById('rideIdForDriver').value;
            const lat = document.getElementById('driverLat').value;
            const lng = document.getElementById('driverLng').value;

            if (!rideId || !lat || !lng) {
                alert('Please provide ride ID and driver coordinates');
                return;
            }

            const reason = prompt('Cancellation reason:') || 'Driver cancelled';
            const response = await makeRequest(`/driver/ride/${rideId}/cancel`, 'POST', {
                reason,
                latitude: parseFloat(lat),
                longitude: parseFloat(lng)
            }, true);
            displayResponse('driver', response);
        }

        async function confirmCashPayment() {
            const rideId = document.getElementById('rideIdForDriver').value;
            if (!rideId) {
                alert('Please provide ride ID');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/confirm-payment`, 'POST', {}, true);
            displayResponse('driver', response);
        }

        async function rateUser() {
            const rideId = document.getElementById('rideIdForDriver').value;
            if (!rideId) {
                alert('Please provide ride ID');
                return;
            }

            const rating = prompt('Rate user (1-5):');
            const comment = prompt('Comment (optional):');
            
            if (!rating || rating < 1 || rating > 5) {
                alert('Please provide a valid rating (1-5)');
                return;
            }

            const response = await makeRequest(`/driver/ride/${rideId}/rate`, 'POST', { 
                rating: parseInt(rating), 
                comment 
            }, true);
            displayResponse('driver', response);
        }

        // Auto-refresh functions for real-time testing
        let autoRefreshInterval = null;

        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            
            autoRefreshInterval = setInterval(() => {
                if (currentRideId) {
                    getRideStatus();
                }
            }, 5000); // Refresh every 5 seconds
            
            document.getElementById('autoRefreshBtn').textContent = '‚èπÔ∏è Stop Auto Refresh';
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('autoRefreshBtn').textContent = 'üîÑ Start Auto Refresh';
            }
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        }

        // Add some helper functions for debugging
        function clearResponses() {
            document.getElementById('userResponseContent').textContent = 'Response cleared...';
            document.getElementById('driverResponseContent').textContent = 'Response cleared...';
        }

        function copyCurrentRideId() {
            if (currentRideId) {
                navigator.clipboard.writeText(currentRideId).then(() => {
                    alert('Ride ID copied to clipboard!');
                    document.getElementById('rideIdForDriver').value = currentRideId;
                });
            } else {
                alert('No current ride ID to copy');
            }
        }

        // Test network connectivity
        async function testConnection() {
            displayResponse('user', 'Testing connection...');
            displayResponse('driver', 'Testing connection...');
            
            try {
                const response = await fetch(`${API_BASE}/Hello`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${USER_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    displayResponse('user', '‚úÖ Connection successful!');
                    displayResponse('driver', '‚úÖ Connection successful!');
                } else {
                    displayResponse('user', `‚ùå Connection failed: ${response.status}`);
                    displayResponse('driver', `‚ùå Connection failed: ${response.status}`);
                }
            } catch (error) {
                displayResponse('user', `‚ùå Network error: ${error.message}`);
                displayResponse('driver', `‚ùå Network error: ${error.message}`);
            }
        }

        // Initialize the app with socket connections
        window.onload = function() {
            testConnection();
            displayResponse('user', 'üöÄ User interface ready!\n\nInstructions:\n1. WebSocket will auto-connect\n2. Fill in pickup and dropoff locations\n3. Choose payment method\n4. Click "Request Ride"\n5. Driver will receive notification via WebSocket');
            displayResponse('driver', 'üöó Driver interface ready!\n\nInstructions:\n1. WebSocket will auto-connect\n2. Wait for ride requests (notifications will appear automatically)\n3. Accept/reject rides using buttons\n4. Follow the ride flow: Arrived ‚Üí Start ‚Üí Complete');
            
            // Auto-connect user socket initially
            connectUserSocket();
            
            // Add socket control buttons
            addSocketControls();
            
            // Auto-connect driver socket after a delay
            setTimeout(() => {
                // connectDriverSocket();
            }, 2000);
        };
    </script>
</body>
</html>